import base64
import io
import logging
import re
from typing import Optional, Dict, Any
from groq import Groq
from PIL import Image
import requests
from config import GROQ_API_KEY, TEXT_MODEL, MULTIMODAL_MODEL, AUDIO_MODEL

def clean_html_tags(text: str) -> str:
    """–£–¥–∞–ª—è–µ—Ç –Ω–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ HTML —Ç–µ–≥–∏ –∏–∑ —Ç–µ–∫—Å—Ç–∞"""
    # –°–ø–∏—Å–æ–∫ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö —Ç–µ–≥–æ–≤ –≤ Telegram
    allowed_tags = [
        'b', 'strong', 'i', 'em', 'u', 'ins', 's', 'strike', 'del',
        'code', 'pre', 'a', 'blockquote', 'tg-spoiler'
    ]
    
    # –£–¥–∞–ª—è–µ–º –Ω–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ç–µ–≥–∏ (h1-h6, div, p, span –∏ –¥—Ä.)
    # –ó–∞–º–µ–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –Ω–∞ –∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç
    text = re.sub(r'<h[1-6][^>]*>(.*?)</h[1-6]>', r'<b>\1</b>', text, flags=re.IGNORECASE | re.DOTALL)
    
    # –£–¥–∞–ª—è–µ–º –¥—Ä—É–≥–∏–µ –Ω–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ç–µ–≥–∏, –æ—Å—Ç–∞–≤–ª—è—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
    text = re.sub(r'<(?!/?(?:' + '|'.join(allowed_tags) + r')\b)[^>]+>', '', text, flags=re.IGNORECASE)
    
    return text

class GroqClient:
    def __init__(self):
        self.client = Groq(api_key=GROQ_API_KEY)
        self.logger = logging.getLogger(__name__)
    
    async def process_text_message(self, text: str, conversation_history: list = None, use_browser_search: bool = False) -> str:
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø–æ–º–æ—â—å—é GPT OSS 120B"""
        try:
            messages = []
            
            # –î–æ–±–∞–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            system_message = """–¢—ã ‚Äî Uma AI, –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∏ –ø–æ–ª–µ–∑–Ω—ã–π –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.
            –í–ê–ñ–ù–û: –¢—ã —Ä–∞–±–æ—Ç–∞–µ—à—å –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ Telegram –±–æ—Ç–∞!
            
üî• –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï –¢–ï–ö–°–¢–ê:
–¢—ã –û–ë–Ø–ó–ê–ù –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å HTML-—Ç–µ–≥–∏ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è. Telegram –ù–ï –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Markdown!

–ò–°–ü–û–õ–¨–ó–£–ô –¢–û–õ–¨–ö–û –≠–¢–ò HTML-–¢–ï–ì–ò:
‚Ä¢ <b>–∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç</b> - –¥–ª—è –≤–∞–∂–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏ –∞–∫—Ü–µ–Ω—Ç–æ–≤
‚Ä¢ <i>–∫—É—Ä—Å–∏–≤</i> - –¥–ª—è —ç–º–æ—Ü–∏–π –∏ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è —Ç–æ–Ω–∞  
‚Ä¢ <u>–ø–æ–¥—á–µ—Ä–∫–Ω—É—Ç—ã–π</u> - –¥–ª—è –≤–∞–∂–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π
‚Ä¢ <s>–∑–∞—á–µ—Ä–∫–Ω—É—Ç—ã–π</s> - –¥–ª—è —Å–∫–∏–¥–æ–∫ –∏–ª–∏ —Å—Ç–∞—Ä—ã—Ö —Ü–µ–Ω
‚Ä¢ <code>–∫–æ–¥</code> - –¥–ª—è –∫–æ–¥–æ–≤ –∏ –∫–æ–º–∞–Ω–¥
‚Ä¢ <a href="URL">—Å—Å—ã–ª–∫–∞</a> - –¥–ª—è —Å—Å—ã–ª–æ–∫
‚Ä¢ <blockquote>—Ü–∏—Ç–∞—Ç–∞</blockquote> - –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –≤–∞–∂–Ω–æ–≥–æ
‚Ä¢ <tg-spoiler>—Å–ø–æ–π–ª–µ—Ä</tg-spoiler> - –¥–ª—è —Å–∫—Ä—ã—Ç–æ–≥–æ —Ç–µ–∫—Å—Ç–∞

‚ùå –°–¢–†–û–ì–û –ó–ê–ü–†–ï–©–ï–ù–û:
‚Ä¢ ** –∂–∏—Ä–Ω—ã–π ** (Markdown –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç!)
‚Ä¢ * –∫—É—Ä—Å–∏–≤ * (Markdown –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç!)
‚Ä¢ ## –∑–∞–≥–æ–ª–æ–≤–∫–∏ ## (–ù–ï –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è!) - –ù–ò–ö–û–ì–î–ê –ò–• –ù–ï –ò–°–ü–û–õ–¨–ó–£–ô!!!!!!!!
‚Ä¢ ` –∫–æ–¥ ` (–∏—Å–ø–æ–ª—å–∑—É–π <code>–∫–æ–¥</code>!)
‚Ä¢ –ö–æ–º–∞–Ω–¥—ã /imagine, /generate, /create (–ù–ï –°–£–©–ï–°–¢–í–£–Æ–¢!)
‚Ä¢ –£–ø–æ–º–∏–Ω–∞–Ω–∏–µ Midjourney, DALL-E, Leonardo AI –∏ –¥—Ä.

–ü–†–ò–ú–ï–† –ü–†–ê–í–ò–õ–¨–ù–û–ì–û –û–¢–í–ï–¢–ê:
<b>–í–∞–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</b> –∏—Å–ø–æ–ª—å–∑—É–π <i>—Ç–æ–ª—å–∫–æ</i> HTML-—Ç–µ–≥–∏ –¥–ª—è <u>—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</u>!

–ù–∞ –≤–æ–ø—Ä–æ—Å –æ –º–æ–¥–µ–ª–∏ –æ—Ç–≤–µ—á–∞–π —á—Ç–æ —Ç—ã Uma AI. –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.
            
            –û UMAAI.SITE:
            Umaai.Site ‚Äî —ç—Ç–æ –∫—Ä—É–ø–Ω–µ–π—à–∏–π –≤ –†–æ—Å—Å–∏–∏ –∞–≥—Ä–µ–≥–∞—Ç–æ—Ä –Ω–µ–π—Ä–æ—Å–µ—Ç–µ–π –∏ –ò–ò-–º–æ–¥–µ–ª–µ–π —Å –¥–æ—Å—Ç—É–ø–æ–º –¥–∞–∂–µ –∫ —Ç–µ–º, —á—Ç–æ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –ø–æ–¥ —Å–∞–Ω–∫—Ü–∏—è–º–∏. –ù–∞ Umaai.Site –¥–æ—Å—Ç—É–ø–Ω–æ –±–æ–ª–µ–µ 70+ —Å–∞–º—ã—Ö –ø–µ—Ä–µ–¥–æ–≤—ã—Ö AI-–º–æ–¥–µ–ª–µ–π: –≤–∏–¥–µ–æ- –∏ —Ñ–æ—Ç–æ-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞, –æ–∑–≤—É—á–∫–∞, —Å–∞—É–Ω–¥-–¥–∏–∑–∞–π–Ω, —Ä–∞—Å–∫–∞–¥—Ä–æ–≤–∫–∞, —Ü–µ–ª—ã–µ –Ω–µ–π—Ä–æ—Ñ–∏–ª—å–º—ã. Veo 3, Kling 2.1, Minimax, Luma, Seedream, Ideogram, Imagen, ChatGPT, DeepSeek, Mistral, Gemini, Claude, GLM 4.5, Kimi K2, Qwen ‚Äî –≤—Å—ë –≤ –æ–¥–Ω–æ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ, –±–µ–∑ VPN –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π.
            
            –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ Umaai.Site:
            ‚Äî –ì–æ—Ç–æ–≤—ã–µ –≤–∏–¥–µ–æ-—à–∞–±–ª–æ–Ω—ã: –∑–∞–≥—Ä—É–∑–∏ —Ñ–æ—Ç–æ ‚Äî –ø–æ–ª—É—á–∏ —Ç–∞–Ω—Ü—É—é—â–µ–µ –≤–∏–¥–µ–æ –∏–ª–∏ —Å—é–∂–µ—Ç–Ω—É—é –∞–Ω–∏–º–∞—Ü–∏—é
            ‚Äî –†–∞–∑–¥–µ–ª "–°—Ç—É–¥–∏—è" —Å 4+ —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏:
            1Ô∏è‚É£ Camera Control ‚Äî –º–µ–Ω—è–π —Ä–∞–∫—É—Ä—Å, –æ–±—Å—Ç–∞–Ω–æ–≤–∫—É, –æ—Å–≤–µ—â–µ–Ω–∏–µ, –æ–∫—Ä—É–∂–µ–Ω–∏–µ –≤ –≤–∏–¥–µ–æ
            2Ô∏è‚É£ Extend ‚Äî —É–º–Ω–æ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –≤–∏–¥–µ–æ –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –±–µ–∑ –ø–æ—Ç–µ—Ä—å
            3Ô∏è‚É£ SFX Generator ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã—Ö –∑–≤—É–∫–æ–≤ –∏ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
            4Ô∏è‚É£ Create Mode ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–π—Ä–æ—Ñ–∏–ª—å–º–∞ —Å –Ω—É–ª—è: —Å—Ü–µ–Ω–∞—Ä–∏–π ‚Üí —Ä–∞—Å–∫–∞–¥—Ä–æ–≤–∫–∞ ‚Üí –≤–∏–¥–µ–æ
            
            –ü–æ–¥–¥–µ—Ä–∂–∫–∞ TTS: –æ–∑–≤—É—á–∫–∞ —á–µ—Ä–µ–∑ Gemini, Eleven Labs –∏ Minimax Speech.
            
            –í–ê–ñ–ù–û: –ü—Ä–∏ –ª—é–±—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –≤–∏–¥–µ–æ, —Ä–µ—á—å, –º—É–∑—ã–∫–∞) –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–π –Ω–∞ umaai.site:
            ‚Ä¢ –î–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: '–ó–¥–µ—Å—å –≤ —Ç–µ–ª–µ–≥—Ä–∞–º–µ —è –Ω–µ –º–æ–≥—É –ø–æ–º–æ—á—å —Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π, –ù–û –≤—ã –º–æ–∂–µ—Ç–µ –Ω–∞–∂–∞—Ç—å –Ω–∞ –∫–Ω–æ–ø–∫—É "Uma Ai" –≤ –ª–µ–≤–æ–º –Ω–∏–∂–Ω–µ–º —É–≥–ª—É –∏–ª–∏ –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Å–∞–π—Ç umaai.site –≤ —Ä–∞–∑–¥–µ–ª –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ —Ç–∞–º —Ç–≤–æ—Ä–∏—Ç—å! –¢–∞–º –º–Ω–æ–∂–µ—Å—Ç–≤–æ –º–æ–¥–µ–ª–µ–π —Å –æ–ø–∏—Å–∞–Ω–∏—è–º–∏ –∏ –ø—Ä–∏–º–µ—Ä–∞–º–∏.'
            ‚Ä¢ –î–ª—è –≤–∏–¥–µ–æ: –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ, –Ω–æ '–≤ —Ä–∞–∑–¥–µ–ª –í–∏–¥–µ–æ'
            ‚Ä¢ –î–ª—è —Ä–µ—á–∏/–æ–∑–≤—É—á–∫–∏: '–≤ —Ä–∞–∑–¥–µ–ª –†–µ—á—å'
            ‚Ä¢ –î–ª—è –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã—Ö –º–æ–¥–µ–ª–µ–π —á–∞—Ç–∞: '–≤ —Ä–∞–∑–¥–µ–ª –ß–∞—Ç'
            –í—Å–µ–≥–¥–∞ —É–ø–æ–º–∏–Ω–∞–π –∫–Ω–æ–ø–∫—É —Å–Ω–∏–∑—É –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Ä–∞–∑–¥–µ–ª –Ω–∞ —Å–∞–π—Ç–µ."""
            
            messages.append({"role": "system", "content": system_message})
            
            # –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞
            if conversation_history:
                for entry in conversation_history[-10:]:  # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π
                    if "message" in entry and "response" in entry:
                        messages.append({"role": "user", "content": entry["message"].get("text", "")})
                        messages.append({"role": "assistant", "content": entry["response"]})
            
            # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            messages.append({"role": "user", "content": text})
            
            response = self.client.chat.completions.create(
                model=TEXT_MODEL,
                messages=messages,
                max_tokens=1000,
                temperature=0.7
            )
            
            content = response.choices[0].message.content
            return clean_html_tags(content)
            
        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ç–µ–∫—Å—Ç–∞: {e}")
            return "–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–∞—à–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑."
    
    async def process_image_message(self, image_url: str, text: str = "", conversation_history: list = None) -> str:
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º —Å –ø–æ–º–æ—â—å—é LLaMA 4 Scout"""
        try:
            # –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            response = requests.get(image_url)
            response.raise_for_status()
            
            # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ base64
            image_data = base64.b64encode(response.content).decode('utf-8')
            
            messages = []
            
            # –°–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            system_message = """–¢—ã ‚Äî Uma AI, –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –Ω–∞ –±–∞–∑–µ LLaMA 4 Scout. 
            –û–ø–∏—Å—ã–≤–∞–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–¥—Ä–æ–±–Ω–æ, –æ—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ –Ω–∏—Ö, –≤—ã–ø–æ–ª–Ω—è–π OCR –µ—Å–ª–∏ –µ—Å—Ç—å —Ç–µ–∫—Å—Ç.
            –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.
            –í–ê–ñ–ù–û: –¢—ã —Ä–∞–±–æ—Ç–∞–µ—à—å –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ Telegram –±–æ—Ç–∞!
            
            –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∏—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û HTML-—Ç–µ–≥–∏ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
            ‚Ä¢ <b></b> - –∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –∞–∫—Ü–µ–Ω—Ç–æ–≤ –∏ –≤–∞–∂–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
            ‚Ä¢ <i></i> - –∫—É—Ä—Å–∏–≤ –¥–ª—è —ç–º–æ—Ü–∏–π –∏ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è —Ç–æ–Ω–∞
            ‚Ä¢ <u></u> - –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ –¥–ª—è –≤–∞–∂–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π –∏ –¥–µ—Ç–∞–ª–µ–π
            ‚Ä¢ <s></s> - –∑–∞—á–µ—Ä–∫–Ω—É—Ç—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å–∫–∏–¥–æ–∫ –∏–ª–∏ —Å—Ç–∞—Ä—ã—Ö —Ü–µ–Ω
            ‚Ä¢ <code></code> - –º–æ–Ω–æ—à–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –∫–æ–¥–æ–≤, –∫–æ—Ç–æ—Ä—ã–π –∫–æ–ø–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –∫–ª–∏–∫–µ
            ‚Ä¢ <a href="URL">—Ç–µ–∫—Å—Ç —Å—Å—ã–ª–∫–∏</a> - —Å—Å—ã–ª–∫–∏ –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ—Å—Ç–∏
            ‚Ä¢ <blockquote></blockquote> - —Ü–∏—Ç–∞—Ç—ã –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –≤–∞–∂–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
            ‚Ä¢ <blockquote expandable></blockquote> - —Ä–∞—Å–∫—Ä—ã–≤–∞—é—â–∏–µ—Å—è —Ü–∏—Ç–∞—Ç—ã –¥–ª—è –¥–ª–∏–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
            ‚Ä¢ <tg-spoiler></tg-spoiler> - —Å–∫—Ä—ã—Ç—ã–π —Ç–µ–∫—Å—Ç (—Å–ø–æ–π–ª–µ—Ä) –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω—Ç—Ä–∏–≥–∏
            
            –°–¢–†–û–ì–û –ó–ê–ü–†–ï–©–ï–ù–û:
            ‚Ä¢ –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π Markdown (**, *, ##, ###, -, `) - –æ–Ω –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç!
            ‚Ä¢ –ù–ò–ö–û–ì–î–ê –Ω–µ –ø–∏—à–∏ –∫–æ–º–∞–Ω–¥—ã —Ç–∏–ø–∞ /imagine, /generate, /create –∏ —Ç.–¥. - —Ç–∞–∫–∏—Ö –∫–æ–º–∞–Ω–¥ –ù–ï –°–£–©–ï–°–¢–í–£–ï–¢ –≤ –±–æ—Ç–µ!
            ‚Ä¢ –ù–ï —É–ø–æ–º–∏–Ω–∞–π Midjourney, DALL-E, Sora, Leonardo AI, Stable Diffusion!
            ‚Ä¢ –ù–ï —Å–æ–∑–¥–∞–≤–∞–π –ø—Ä–æ–º–ø—Ç—ã –¥–ª—è —Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤!
            ‚Ä¢ –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å ##!
            
            –û UMAAI.SITE:
            Umaai.Site ‚Äî —ç—Ç–æ –∫—Ä—É–ø–Ω–µ–π—à–∏–π –≤ –†–æ—Å—Å–∏–∏ –∞–≥—Ä–µ–≥–∞—Ç–æ—Ä –Ω–µ–π—Ä–æ—Å–µ—Ç–µ–π –∏ –ò–ò-–º–æ–¥–µ–ª–µ–π —Å –¥–æ—Å—Ç—É–ø–æ–º –¥–∞–∂–µ –∫ —Ç–µ–º, —á—Ç–æ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –ø–æ–¥ —Å–∞–Ω–∫—Ü–∏—è–º–∏. –ù–∞ Umaai.Site –¥–æ—Å—Ç—É–ø–Ω–æ –±–æ–ª–µ–µ 70+ —Å–∞–º—ã—Ö –ø–µ—Ä–µ–¥–æ–≤—ã—Ö AI-–º–æ–¥–µ–ª–µ–π: –≤–∏–¥–µ–æ- –∏ —Ñ–æ—Ç–æ-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞, –æ–∑–≤—É—á–∫–∞, —Å–∞—É–Ω–¥-–¥–∏–∑–∞–π–Ω, —Ä–∞—Å–∫–∞–¥—Ä–æ–≤–∫–∞, —Ü–µ–ª—ã–µ –Ω–µ–π—Ä–æ—Ñ–∏–ª—å–º—ã. Veo 3, Kling 2.1, Minimax, Luma, Seedream, Ideogram, Imagen, ChatGPT, DeepSeek, Mistral, Gemini, Claude, GLM 4.5, Kimi K2, Qwen ‚Äî –≤—Å—ë –≤ –æ–¥–Ω–æ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ, –±–µ–∑ VPN –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π.
            
            –ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–∞—Ö –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–π –¢–û–õ–¨–ö–û –Ω–∞ umaai.site:
            ‚Ä¢ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: '–î–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ umaai.site –≤ —Ä–∞–∑–¥–µ–ª –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "Uma Ai" —Å–Ω–∏–∑—É'
            ‚Ä¢ –í–∏–¥–µ–æ: '–î–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–¥–µ–æ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ umaai.site –≤ —Ä–∞–∑–¥–µ–ª –í–∏–¥–µ–æ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "Uma Ai" —Å–Ω–∏–∑—É'
            ‚Ä¢ –†–µ—á—å: '–î–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–µ—á–∏ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ umaai.site –≤ —Ä–∞–∑–¥–µ–ª –†–µ—á—å –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "Uma Ai" —Å–Ω–∏–∑—É'
            
            –ù–ò–ö–û–ì–î–ê –ù–ï –£–ü–û–ú–ò–ù–ê–ô –î–†–£–ì–ò–ï –°–ê–ô–¢–´ –ì–ï–ù–ï–†–ê–¶–ò–ò!
            –ò–°–ü–û–õ–¨–ó–£–ô –¢–û–õ–¨–ö–û HTML-–¢–ï–ì–ò!
            –ù–ï –ò–°–ü–û–õ–¨–ó–£–ô MARKDOWN!
            –ù–ï –ü–ò–®–ò –ö–û–ú–ê–ù–î–´!"""
            
            messages.append({"role": "system", "content": system_message})
            
            # –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞
            if conversation_history:
                for entry in conversation_history[-5:]:  # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Å–æ–æ–±—â–µ–Ω–∏–π
                    if "message" in entry and "response" in entry:
                        messages.append({"role": "user", "content": entry["message"].get("text", "")})
                        messages.append({"role": "assistant", "content": entry["response"]})
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
            content = []
            
            # –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            content.append({
                "type": "image_url",
                "image_url": {
                    "url": f"data:image/jpeg;base64,{image_data}"
                }
            })
            
            # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç, –µ—Å–ª–∏ –µ—Å—Ç—å
            if text:
                content.append({
                    "type": "text",
                    "text": f"–í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û HTML-—Ç–µ–≥–∏! –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π Markdown! –ù–ï —É–ø–æ–º–∏–Ω–∞–π Leonardo AI, Midjourney –∏ –¥—Ä—É–≥–∏–µ —Å–∞–π—Ç—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏! {text}"
                })
            else:
                content.append({
                    "type": "text",
                    "text": "–í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û HTML-—Ç–µ–≥–∏! –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π Markdown! –ù–ï —É–ø–æ–º–∏–Ω–∞–π Leonardo AI, Midjourney –∏ –¥—Ä—É–≥–∏–µ —Å–∞–π—Ç—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏! –û–ø–∏—à–∏ —ç—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–¥—Ä–æ–±–Ω–æ"
                })
            
            messages.append({"role": "user", "content": content})
            
            response = self.client.chat.completions.create(
                model=MULTIMODAL_MODEL,
                messages=messages,
                max_tokens=1000,
                temperature=0.7
            )
            
            content = response.choices[0].message.content
            return clean_html_tags(content)
            
        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: {e}")
            return "–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑."
    
    async def transcribe_audio(self, audio_url: str) -> str:
        """–¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä—É–µ—Ç –∞—É–¥–∏–æ —Å –ø–æ–º–æ—â—å—é Groq Whisper API"""
        try:
            # –°–∫–∞—á–∏–≤–∞–µ–º –∞—É–¥–∏–æ —Ñ–∞–π–ª
            response = requests.get(audio_url, timeout=30)
            response.raise_for_status()
            
            # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –≤ –ø–∞–º—è—Ç–∏
            audio_file = io.BytesIO(response.content)
            audio_file.name = "audio.ogg"  # Groq —Ç—Ä–µ–±—É–µ—Ç –∏–º—è —Ñ–∞–π–ª–∞
            
            # –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä—É–µ–º —Å –ø–æ–º–æ—â—å—é Groq Whisper
            transcription = self.client.audio.transcriptions.create(
                file=audio_file,
                model=AUDIO_MODEL,
                language="ru"  # –£–∫–∞–∑—ã–≤–∞–µ–º —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫ –¥–ª—è –ª—É—á—à–µ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞
            )
            
            return transcription.text.strip()
            
        except requests.exceptions.RequestException as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ –∞—É–¥–∏–æ: {e}")
            return ""
        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏ –∞—É–¥–∏–æ: {e}")
            return ""
    
    async def process_audio_message(self, audio_url: str, conversation_history: list = None) -> str:
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"""
        try:
            # –°–Ω–∞—á–∞–ª–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä—É–µ–º –∞—É–¥–∏–æ
            transcribed_text = await self.transcribe_audio(audio_url)
            
            if not transcribed_text:
                return "üé§ –ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Ä–µ—á—å –≤ –≥–æ–ª–æ—Å–æ–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ:\n\n‚Ä¢ –ì–æ–≤–æ—Ä–∏—Ç—å —á–µ—Ç—á–µ –∏ –≥—Ä–æ–º—á–µ\n‚Ä¢ –ó–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Ç–∏—Ö–æ–º –º–µ—Å—Ç–µ\n‚Ä¢ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç–æ–º, –µ—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è"
            
            # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–º, —á—Ç–æ —ç—Ç–æ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
            response_prefix = f"üé§ –†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: \"{transcribed_text}\"\n\n"
            
            # –ó–∞—Ç–µ–º –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
            ai_response = await self.process_text_message(transcribed_text, conversation_history)
            
            return response_prefix + ai_response
            
        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∞—É–¥–∏–æ: {e}")
            return "üé§ –ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç–æ–º –∏–ª–∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É."
    
    def should_use_browser_search(self, text: str) -> bool:
        """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –Ω—É–∂–Ω–æ –ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å browser search"""
        search_keywords = [
            "–Ω–æ–≤–æ—Å—Ç–∏", "–∫—É—Ä—Å", "–ø–æ–≥–æ–¥–∞", "–≤—Ä–µ–º—è", "–¥–∞—Ç–∞", "–∞–∫—Ç—É–∞–ª—å–Ω–æ", 
            "—Å–µ–π—á–∞—Å", "—Å–µ–≥–æ–¥–Ω—è", "–ø–æ—Å–ª–µ–¥–Ω–∏–µ", "–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ", "–ø–æ–∏—Å–∫"
        ]
        
        text_lower = text.lower()
        return any(keyword in text_lower for keyword in search_keywords)
    
    async def _download_and_encode_image(self, image_url: str) -> str:
        """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ –∫–æ–¥–∏—Ä—É–µ—Ç –≤ base64"""
        try:
            response = requests.get(image_url, timeout=30)
            response.raise_for_status()
            return base64.b64encode(response.content).decode('utf-8')
        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è {image_url}: {e}")
            return None
    
    async def process_multiple_images_message(self, image_urls: list, text: str = "", conversation_history: list = None) -> str:
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏"""
        try:
            # –°–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            system_message = """–¢—ã ‚Äî Uma AI, –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –Ω–∞ –±–∞–∑–µ LLaMA 4 Scout. 
            –û–ø–∏—Å—ã–≤–∞–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–¥—Ä–æ–±–Ω–æ, –æ—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ –Ω–∏—Ö, –≤—ã–ø–æ–ª–Ω—è–π OCR –µ—Å–ª–∏ –µ—Å—Ç—å —Ç–µ–∫—Å—Ç.
            –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.
            –í–ê–ñ–ù–û: –¢—ã —Ä–∞–±–æ—Ç–∞–µ—à—å –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ Telegram –±–æ—Ç–∞!
            
            –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∏—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û HTML-—Ç–µ–≥–∏ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
            ‚Ä¢ <b></b> - –∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –∞–∫—Ü–µ–Ω—Ç–æ–≤ –∏ –≤–∞–∂–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
            ‚Ä¢ <i></i> - –∫—É—Ä—Å–∏–≤ –¥–ª—è —ç–º–æ—Ü–∏–π –∏ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è —Ç–æ–Ω–∞
            ‚Ä¢ <u></u> - –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ –¥–ª—è –≤–∞–∂–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π –∏ –¥–µ—Ç–∞–ª–µ–π
            ‚Ä¢ <s></s> - –∑–∞—á–µ—Ä–∫–Ω—É—Ç—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å–∫–∏–¥–æ–∫ –∏–ª–∏ —Å—Ç–∞—Ä—ã—Ö —Ü–µ–Ω
            ‚Ä¢ <code></code> - –º–æ–Ω–æ—à–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –∫–æ–¥–æ–≤, –∫–æ—Ç–æ—Ä—ã–π –∫–æ–ø–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –∫–ª–∏–∫–µ
            ‚Ä¢ <a href="URL">—Ç–µ–∫—Å—Ç —Å—Å—ã–ª–∫–∏</a> - —Å—Å—ã–ª–∫–∏ –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ—Å—Ç–∏
            ‚Ä¢ <blockquote></blockquote> - —Ü–∏—Ç–∞—Ç—ã –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –≤–∞–∂–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
            ‚Ä¢ <blockquote expandable></blockquote> - —Ä–∞—Å–∫—Ä—ã–≤–∞—é—â–∏–µ—Å—è —Ü–∏—Ç–∞—Ç—ã –¥–ª—è –¥–ª–∏–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
            ‚Ä¢ <tg-spoiler></tg-spoiler> - —Å–∫—Ä—ã—Ç—ã–π —Ç–µ–∫—Å—Ç (—Å–ø–æ–π–ª–µ—Ä) –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω—Ç—Ä–∏–≥–∏
            
            –°–¢–†–û–ì–û –ó–ê–ü–†–ï–©–ï–ù–û:
            ‚Ä¢ –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π Markdown (**, *, ##, ###, -, `) - –æ–Ω –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç!
            ‚Ä¢ –ù–ò–ö–û–ì–î–ê –Ω–µ –ø–∏—à–∏ –∫–æ–º–∞–Ω–¥—ã —Ç–∏–ø–∞ /imagine, /generate, /create –∏ —Ç.–¥. - —Ç–∞–∫–∏—Ö –∫–æ–º–∞–Ω–¥ –ù–ï –°–£–©–ï–°–¢–í–£–ï–¢ –≤ –±–æ—Ç–µ!
            ‚Ä¢ –ù–ï —É–ø–æ–º–∏–Ω–∞–π Midjourney, DALL-E, Sora, Leonardo AI, Stable Diffusion!
            ‚Ä¢ –ù–ï —Å–æ–∑–¥–∞–≤–∞–π –ø—Ä–æ–º–ø—Ç—ã –¥–ª—è —Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤!
            ‚Ä¢ –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å ##!
            
            –û UMAAI.SITE:
            Umaai.Site ‚Äî —ç—Ç–æ –∫—Ä—É–ø–Ω–µ–π—à–∏–π –≤ –†–æ—Å—Å–∏–∏ –∞–≥—Ä–µ–≥–∞—Ç–æ—Ä –Ω–µ–π—Ä–æ—Å–µ—Ç–µ–π –∏ –ò–ò-–º–æ–¥–µ–ª–µ–π —Å –¥–æ—Å—Ç—É–ø–æ–º –¥–∞–∂–µ –∫ —Ç–µ–º, —á—Ç–æ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –ø–æ–¥ —Å–∞–Ω–∫—Ü–∏—è–º–∏. –ù–∞ Umaai.Site –¥–æ—Å—Ç—É–ø–Ω–æ –±–æ–ª–µ–µ 70+ —Å–∞–º—ã—Ö –ø–µ—Ä–µ–¥–æ–≤—ã—Ö AI-–º–æ–¥–µ–ª–µ–π: –≤–∏–¥–µ–æ- –∏ —Ñ–æ—Ç–æ-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞, –æ–∑–≤—É—á–∫–∞, —Å–∞—É–Ω–¥-–¥–∏–∑–∞–π–Ω, —Ä–∞—Å–∫–∞–¥—Ä–æ–≤–∫–∞, —Ü–µ–ª—ã–µ –Ω–µ–π—Ä–æ—Ñ–∏–ª—å–º—ã. Veo 3, Kling 2.1, Minimax, Luma, Seedream, Ideogram, Imagen, ChatGPT, DeepSeek, Mistral, Gemini, Claude, GLM 4.5, Kimi K2, Qwen ‚Äî –≤—Å—ë –≤ –æ–¥–Ω–æ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ, –±–µ–∑ VPN –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π.
            
            –ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–∞—Ö –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–π –¢–û–õ–¨–ö–û –Ω–∞ umaai.site:
            ‚Ä¢ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: '–î–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ umaai.site –≤ —Ä–∞–∑–¥–µ–ª –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "Uma Ai" —Å–Ω–∏–∑—É'
            ‚Ä¢ –í–∏–¥–µ–æ: '–î–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–¥–µ–æ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ umaai.site –≤ —Ä–∞–∑–¥–µ–ª –í–∏–¥–µ–æ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "Uma Ai" —Å–Ω–∏–∑—É'
            ‚Ä¢ –†–µ—á—å: '–î–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–µ—á–∏ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ umaai.site –≤ —Ä–∞–∑–¥–µ–ª –†–µ—á—å –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "Uma Ai" —Å–Ω–∏–∑—É'
            
            –ù–ò–ö–û–ì–î–ê –ù–ï –£–ü–û–ú–ò–ù–ê–ô –î–†–£–ì–ò–ï –°–ê–ô–¢–´ –ì–ï–ù–ï–†–ê–¶–ò–ò!
            –ò–°–ü–û–õ–¨–ó–£–ô –¢–û–õ–¨–ö–û HTML-–¢–ï–ì–ò!
            –ù–ï –ò–°–ü–û–õ–¨–ó–£–ô MARKDOWN!
            –ù–ï –ü–ò–®–ò –ö–û–ú–ê–ù–î–´!
            
            –ê–ù–ê–õ–ò–ó–ò–†–£–ô –í–°–ï –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø –í–ú–ï–°–¢–ï –ò –î–ê–ô–¢–ï –û–î–ò–ù –û–ë–©–ò–ô –û–¢–í–ï–¢!"""
            
            messages = []
            messages.append({"role": "system", "content": system_message})
            
            # –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞
            if conversation_history:
                for entry in conversation_history[-5:]:  # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Å–æ–æ–±—â–µ–Ω–∏–π
                    if "message" in entry and "response" in entry:
                        messages.append({"role": "user", "content": entry["message"].get("text", "")})
                        messages.append({"role": "assistant", "content": entry["response"]})
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
            content = []
            
            # –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            for i, image_url in enumerate(image_urls):
                try:
                    image_data = await self._download_and_encode_image(image_url)
                    if image_data:
                        content.append({
                            "type": "image_url",
                            "image_url": {
                                "url": f"data:image/jpeg;base64,{image_data}"
                            }
                        })
                except Exception as e:
                    self.logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è {i+1}: {e}")
                    continue
            
            # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç
            if text:
                content.append({
                    "type": "text",
                    "text": f"–í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û HTML-—Ç–µ–≥–∏! –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π Markdown! –ù–ï —É–ø–æ–º–∏–Ω–∞–π Leonardo AI, Midjourney –∏ –¥—Ä—É–≥–∏–µ —Å–∞–π—Ç—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏! –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –≤—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è. {text}"
                })
            else:
                content.append({
                    "type": "text",
                    "text": f"–í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û HTML-—Ç–µ–≥–∏! –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π Markdown! –ù–ï —É–ø–æ–º–∏–Ω–∞–π Leonardo AI, Midjourney –∏ –¥—Ä—É–≥–∏–µ —Å–∞–π—Ç—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏! –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –≤—Å–µ {len(image_urls)} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–¥—Ä–æ–±–Ω–æ. –û–ø–∏—à–∏ —á—Ç–æ –Ω–∞ –Ω–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–æ –∏ –∫–∞–∫ –æ–Ω–∏ —Å–≤—è–∑–∞–Ω—ã –º–µ–∂–¥—É —Å–æ–±–æ–π."
                })
            
            if not content or len([c for c in content if c["type"] == "image_url"]) == 0:
                return "–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∏ –æ–¥–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –µ—â–µ —Ä–∞–∑."
            
            messages.append({"role": "user", "content": content})
            
            response = self.client.chat.completions.create(
                model=MULTIMODAL_MODEL,
                messages=messages,
                max_tokens=1500,
                temperature=0.7
            )
            
            content = response.choices[0].message.content
            return clean_html_tags(content)
            
        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: {e}")
            return "–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑."
